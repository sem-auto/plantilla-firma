<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Fichaje rápido (Foto o Firma)</title>
<style>
  :root { --gap:18px; --radius:16px; --card:#ffffff; --bg:#eef2f6; --ok:#198754; --warn:#dc3545; }
  *{ box-sizing:border-box; }
  html,body{ height:100%; margin:0; font-family:system-ui, Arial, sans-serif; background:var(--bg); color:#111; }
  .wrap{ max-width:1100px; margin:0 auto; padding:28px 20px 40px; }
  h1{ margin:0 0 20px; font-size:34px; font-weight:800; color:#0b1b2b; }
  .top{ display:grid; grid-template-columns:1fr 360px; gap:22px; align-items:start; }
  .cam{
    background:var(--card); border-radius:14px; padding:12px; box-shadow:0 8px 28px rgba(0,0,0,.08);
    display:grid; gap:10px; justify-items:center;
  }
  .cam > .frame{ width:100%; aspect-ratio:4/3; background:#000; border-radius:12px; overflow:hidden; }
  video, canvas.preview{ width:100%; height:100%; object-fit:cover; display:block; }
  .note{ font-size:12px; color:#6b7280; text-align:center; }
  .row{
    background:var(--card); border-radius:14px; padding:12px 12px; box-shadow:0 8px 28px rgba(0,0,0,.08);
    display:grid; grid-template-columns:1fr auto; align-items:center; gap:10px; margin-bottom:14px;
  }
  .emp{ font-weight:800; color:#0f172a; padding:12px 16px; background:#f7fafc; border-radius:12px; }
  .btns{ display:flex; gap:10px; flex-wrap:wrap; }
  .btn{
    border:0; border-radius:12px; padding:10px 14px; font-weight:800; cursor:pointer; box-shadow:0 6px 20px rgba(0,0,0,.06);
  }
  .b-foto{ background:var(--ok); color:#fff; }
  .b-firma{ background:#1f2937; color:#fff; }
  .b-sal{ background:#0d6efd; color:#fff; }
  .b-clear{ background:#e5e7eb; color:#111; }
  .sigCard{ background:var(--card); border-radius:14px; padding:14px; box-shadow:0 8px 28px rgba(0,0,0,.08); }
  #sig{ width:100%; height:240px; border:1px dashed #cbd5e1; border-radius:12px; background:#fff; touch-action:none; }
  .status{
    margin-top:16px; background:#fff; border-radius:12px; padding:10px 14px; color:#374151; display:flex; justify-content:space-between;
    box-shadow:0 8px 28px rgba(0,0,0,.06); font-size:14px;
  }
</style>
</head>
<body>
<div class="wrap">
  <h1>Fichaje rápido</h1>

  <div class="top">
    <!-- LISTA DE TRABAJADORES + ACCIONES -->
    <div id="lista">
      <!-- Filas generadas por JS a partir del array WORKERS -->
    </div>

    <!-- CÁMARA -->
    <div class="cam">
      <div class="frame">
        <video id="video" playsinline autoplay muted></video>
        <canvas id="photoPreview" class="preview" hidden></canvas>
      </div>
      <div class="btns">
        <button id="camOn" class="btn b-foto">Encender cámara</button>
        <button id="snap" class="btn b-clear">Tomar foto</button>
        <button id="camOff" class="btn b-clear">Apagar cámara</button>
      </div>
      <div class="note" id="camNote">Sin acceso a cámara</div>
    </div>
  </div>

  <!-- FIRMA -->
  <div style="margin-top:18px;" class="sigCard">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:8px;">
      <strong>Firma diaria</strong>
      <div class="btns">
        <button id="clearSig" class="btn b-clear">Borrar firma</button>
        <button id="sendSig" class="btn b-firma">Enviar firma</button>
      </div>
    </div>
    <canvas id="sig"></canvas>
    <div class="note">Firma con el dedo o lápiz. La firma se registra en la hoja.</div>
  </div>

  <!-- STATUS -->
  <div class="status">
    <div id="status">Listo.</div>
    <div id="clock"></div>
  </div>
</div>

<audio id="beep">
  <source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYBCAAAAB8AAA==" type="audio/wav">
</audio>

<script>
/* ===== CONFIG ===== */
const ENDPOINT = "https://script.google.com/macros/s/AKfycbxlR17AJQw87pZgALcfRTE__1ud65aXrRj7B0OG7tu3Lj5s1bCsFRw09WS81qDa2Q-k/exec";
const WORKERS = [
  "Ana López Martín",
  "Carla Gómez Torres",
  "Luis Fernández Díaz",
  "Diego Pérez Ruiz"
];
const JPEG_QUALITY=0.7, MAX_W=1024, MAX_H=768;

/* ===== ELEMENTOS ===== */
const $ = s=>document.querySelector(s);
const lista = $("#lista");
const statusEl = $("#status");
const beep = $("#beep");

/* ===== RELOJ ===== */
setInterval(()=>{
  const d=new Date();
  $("#clock").textContent = d.toLocaleString("es-ES",{weekday:'short', day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit'});
}, 250);

/* ===== LISTA UI ===== */
WORKERS.forEach(n=>{
  const row=document.createElement("div");
  row.className="row";
  row.innerHTML = `
    <div class="emp">${n}</div>
    <div class="btns">
      <button class="btn b-foto"   data-emp="${n}" data-tipo="entrada" data-mode="foto">Foto ENTRADA</button>
      <button class="btn b-firma"  data-emp="${n}" data-tipo="entrada" data-mode="firma">Firma ENTRADA</button>
      <button class="btn b-foto b-sal"   data-emp="${n}" data-tipo="salida"  data-mode="foto">Foto SALIDA</button>
      <button class="btn b-firma b-sal"  data-emp="${n}" data-tipo="salida"  data-mode="firma">Firma SALIDA</button>
    </div>`;
  lista.appendChild(row);
});
lista.addEventListener("click", async ev=>{
  const b = ev.target;
  if(!(b instanceof HTMLButtonElement)) return;
  const nombre = b.dataset.emp, tipo = b.dataset.tipo, modo = b.dataset.mode;

  if(modo==="foto"){
    await ensureCam();
    const {blob} = grabFrameToBlob(video, MAX_W, MAX_H, JPEG_QUALITY);
    await send({nombre, tipo, modo, blob});
    ok();
  }else{
    // preparar envío de firma: guarda el contexto de a quién corresponde
    pendingSig = {nombre, tipo};
    setStatus(`Firma pendiente para ${nombre} (${tipo}). Dibuja y pulsa "Enviar firma".`);
    // scroll a firma
    document.querySelector(".sigCard").scrollIntoView({behavior:"smooth", block:"center"});
  }
});

/* ===== CÁMARA ===== */
const video = $("#video");
const preview = $("#photoPreview");
const camOn = $("#camOn"), camOff=$("#camOff"), snap=$("#snap"), camNote=$("#camNote");
let stream=null;

camOn.onclick = ensureCam;
camOff.onclick = async()=>{ await stopCam(); setStatus("Cámara apagada."); };
snap.onclick = ()=>{
  if(!video.videoWidth){ setStatus("Enciende la cámara."); return; }
  const {canvas} = grabFrameToBlob(video, MAX_W, MAX_H, JPEG_QUALITY);
  preview.width = canvas.width; preview.height = canvas.height;
  const ctx = preview.getContext("2d"); ctx.drawImage(canvas,0,0);
  preview.hidden=false; setStatus("Foto preparada.");
};

async function ensureCam(){
  if(stream) return;
  try{
    stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}, audio:false});
    video.srcObject = stream;
    camNote.textContent="Cámara activa";
  }catch(e){ camNote.textContent="Sin acceso a cámara"; setStatus("Error cámara: "+e.message); }
}
async function stopCam(){
  if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; video.srcObject=null; }
  preview.hidden=true;
}
function grabFrameToBlob(video, maxW, maxH, quality){
  const cw=video.videoWidth, ch=video.videoHeight;
  const s=Math.min(maxW/cw, maxH/ch, 1), w=Math.round(cw*s), h=Math.round(ch*s);
  const c=document.createElement("canvas"); c.width=w; c.height=h;
  c.getContext("2d").drawImage(video,0,0,w,h);
  const dataURL=c.toDataURL("image/jpeg",quality);
  const blob=dataURLtoBlob(dataURL);
  return {canvas:c, blob};
}
function dataURLtoBlob(dataURL){
  const parts=dataURL.split(','), mime=parts[0].match(/:(.*?);/)[1];
  const bin=atob(parts[1]); const u8=new Uint8Array(bin.length);
  for(let i=0;i<bin.length;i++) u8[i]=bin.charCodeAt(i);
  return new Blob([u8],{type:mime});
}

/* ===== FIRMA ===== */
const sig=$("#sig"), ctx=sig.getContext("2d");
let drawing=false, hasStroke=false, last={x:0,y:0}, pendingSig=null;
function fitSig(){
  const r=Math.max(window.devicePixelRatio||1,1);
  sig.width = sig.clientWidth*r; sig.height=sig.clientHeight*r; ctx.setTransform(r,0,0,r,0,0);
  ctx.lineCap="round"; ctx.lineJoin="round"; ctx.lineWidth=3; ctx.strokeStyle="#111";
}
fitSig(); addEventListener("resize", fitSig);
function p(ev){ const r=sig.getBoundingClientRect(); const t=ev.touches?ev.touches[0]:ev; return {x:t.clientX-r.left, y:t.clientY-r.top}; }
function start(ev){ drawing=true; hasStroke=true; last=p(ev); ev.preventDefault(); }
function move(ev){ if(!drawing) return; const m=p(ev); ctx.beginPath(); ctx.moveTo(last.x,last.y); ctx.lineTo(m.x,m.y); ctx.stroke(); last=m; ev.preventDefault(); }
function end(){ drawing=false; }
sig.addEventListener("mousedown",start); sig.addEventListener("mousemove",move); addEventListener("mouseup",end);
sig.addEventListener("touchstart",start,{passive:false}); sig.addEventListener("touchmove",move,{passive:false}); sig.addEventListener("touchend",end);

$("#clearSig").onclick=()=>{ ctx.clearRect(0,0,sig.width,sig.height); hasStroke=false; setStatus("Firma borrada."); };

$("#sendSig").onclick=async ()=>{
  if(!pendingSig){ setStatus("Selecciona primero el trabajador y el tipo (botón Firma)."); return; }
  if(!hasStroke){ setStatus("Firma requerida."); return; }
  const blob = await new Promise(res=>sig.toBlob(b=>res(b),"image/jpeg",JPEG_QUALITY));
  await send({nombre:pendingSig.nombre, tipo:pendingSig.tipo, modo:"firma", blob});
  ok(); pendingSig=null; ctx.clearRect(0,0,sig.width,sig.height); hasStroke=false;
};

/* ===== ENVÍO ===== */
async function send({nombre, tipo, modo, blob}){
  setStatus(`Enviando ${modo} — ${nombre} (${tipo})...`);
  const fd = new FormData();
  fd.append("nombre", nombre);
  fd.append("tipo", tipo);
  fd.append("modo", modo);
  if(blob) fd.append("imagen", blob, `${modo}.jpg`);

  // POST con timeout + fallback GET
  const ctrl=new AbortController(); const to=setTimeout(()=>ctrl.abort(), 9000);
  try{
    const r = await fetch(ENDPOINT, {method:"POST", body:fd, signal:ctrl.signal});
    clearTimeout(to);
    if(!r.ok) throw new Error("HTTP "+r.status);
    const txt=await r.text();
    if(!/OK|ok/.test(txt)) setStatus(txt.trim());
  }catch(e){
    const url = `${ENDPOINT}?nombre=${encodeURIComponent(nombre)}&tipo=${encodeURIComponent(tipo)}&modo=${encodeURIComponent(modo)}`;
    const r2 = await fetch(url, {method:"GET", cache:"no-store"});
    if(!r2.ok){ const t=await r2.text(); throw new Error("GET "+r2.status+": "+t); }
  }
}
function ok(){ setStatus("Registrado."); try{ beep.currentTime=0; beep.play().catch(()=>{});}catch(_){ } }
function setStatus(t){ statusEl.textContent=t; }
</script>
</body>
</html>

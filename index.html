<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Fichaje con Firma</title>
<style>
  body{
    background:#f4f6f8; color:#111; font-family:system-ui, Arial, sans-serif;
    min-height:100vh; margin:0; padding:20px;
    display:flex; flex-direction:column; align-items:center; justify-content:flex-start;
  }
  h1{ font-size:20px; margin-bottom:8px; }
  p.small{ color:#555; font-size:13px; margin-top:0; margin-bottom:16px; }
  .grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px; width:100%; max-width:600px; margin-bottom:20px; }
  .btn{
    padding:16px; font-size:14px; font-weight:700;
    border:0; border-radius:10px; cursor:pointer; color:#fff;
  }
  .entrada{ background:#22c55e; }
  .salida{ background:#dc2626; }
  canvas{ border:2px dashed #999; border-radius:10px; background:#fff; touch-action:none; width:100%; height:180px; }
  .actions{ margin-top:10px; display:flex; gap:10px; }
  .actions button{
    flex:1; padding:12px; border:0; border-radius:8px; font-weight:700; cursor:pointer;
  }
  .clear{ background:#e5e7eb; }
  .send{ background:#0f62fe; color:#fff; }
  #status{ margin-top:14px; font-size:14px; color:#333; }
</style>
</head>
<body>
  <h1>Fichaje Empresa</h1>
  <p class="small">Pulsa tu botón, firma y envía.</p>

  <div class="grid">
    <button class="btn entrada" onclick="pick('Marcos Bernal Ortega','entrada')">Marcos Bernal Ortega — ENTRADA</button>
    <button class="btn salida"  onclick="pick('Marcos Bernal Ortega','salida')">Marcos Bernal Ortega — SALIDA</button>
    <button class="btn entrada" onclick="pick('Carla Gomez Torres','entrada')">Carla Gomez Torres — ENTRADA</button>
    <button class="btn salida"  onclick="pick('Carla Gomez Torres','salida')">Carla Gomez Torres — SALIDA</button>
  </div>

  <canvas id="sig"></canvas>
  <div class="actions">
    <button class="clear" onclick="clearSig()">Borrar</button>
    <button class="send" id="btnEnviar">Enviar</button>
  </div>

  <div id="status">Listo.</div>

  <audio id="beep_ok" preload="auto">
    <source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYBCAAAAB8AAA==" type="audio/wav" />
  </audio>

<script>
const ENDPOINT = "https://script.google.com/macros/s/AKfycbxlR17AJQw87pZgALcfRTE__1ud65aXrRj7B0OG7tu3Lj5s1bCsFRw09WS81qDa2Q-k/exec";
const JPEG_QUALITY = 0.8;

let nombreActual="", tipoActual="";
function pick(n,t){ nombreActual=n; tipoActual=t; status(`Seleccionado: ${n} → ${t}`); }

const sig = document.getElementById("sig");
const ctx = sig.getContext("2d");
let drawing=false, hasStroke=false, last={x:0,y:0};

function resizeCanvas(){
  const ratio = window.devicePixelRatio||1;
  sig.width = sig.clientWidth*ratio;
  sig.height= sig.clientHeight*ratio;
  ctx.scale(ratio,ratio);
  ctx.lineCap="round"; ctx.lineJoin="round"; ctx.lineWidth=2; ctx.strokeStyle="#000";
}
resizeCanvas(); window.onresize=resizeCanvas;

function pos(ev){
  const r=sig.getBoundingClientRect();
  return { x:(ev.touches?ev.touches[0].clientX:ev.clientX)-r.left,
           y:(ev.touches?ev.touches[0].clientY:ev.clientY)-r.top };
}
sig.addEventListener("mousedown",e=>{drawing=true; last=pos(e);});
sig.addEventListener("mousemove",e=>{if(!drawing)return;const p=pos(e);ctx.beginPath();ctx.moveTo(last.x,last.y);ctx.lineTo(p.x,p.y);ctx.stroke();last=p;hasStroke=true;});
window.addEventListener("mouseup",()=>drawing=false);
sig.addEventListener("touchstart",e=>{drawing=true; last=pos(e); e.preventDefault();});
sig.addEventListener("touchmove",e=>{if(!drawing)return;const p=pos(e);ctx.beginPath();ctx.moveTo(last.x,last.y);ctx.lineTo(p.x,p.y);ctx.stroke();last=p;hasStroke=true; e.preventDefault();});
sig.addEventListener("touchend",()=>drawing=false);

function clearSig(){ ctx.clearRect(0,0,sig.width,sig.height); hasStroke=false; status("Firma borrada."); }
function status(t){ document.getElementById("status").textContent=t; }
function beep(){ try{ const a=document.getElementById("beep_ok"); a.currentTime=0; a.play().catch(()=>{});}catch(_){} }

document.getElementById("btnEnviar").onclick=async()=>{
  if(!nombreActual||!tipoActual){ status("Selecciona trabajador y tipo."); return; }
  if(!hasStroke){ status("Firma requerida."); return; }

  status("Enviando...");
  try{
    const dataURL = sig.toDataURL("image/jpeg", JPEG_QUALITY);
    const txId = "tx_"+Date.now()+"_"+Math.random().toString(36).slice(2,8);

    const fd=new FormData();
    fd.append("nombre", nombreActual);
    fd.append("tipo", tipoActual);
    fd.append("modo","firma");
    fd.append("txId", txId);
    fd.append("imagen", dataURL);

    await fetch(ENDPOINT,{method:"POST",body:fd});

    beep();
    status(`OK: ${nombreActual} — ${tipoActual}`);
    clearSig();
  }catch(e){ status("Error: "+e.message); }
};
</script>
</body>
</html>

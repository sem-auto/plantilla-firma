<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Fichaje por Firma</title>
<style>
  :root { --gap:16px; --radius:16px; --maxw:820px; --statusH:52px; }
  *{ box-sizing:border-box; }
  html,body{ height:100%; margin:0; }
  body{
    background:#f4f6f8; color:#111; font-family:system-ui, Arial, sans-serif;
    min-height:100dvh; padding:var(--gap); display:grid; place-items:start center;
  }
  .wrap{ width:100%; max-width:var(--maxw); background:#fff; border-radius:var(--radius);
         box-shadow:0 6px 30px rgba(0,0,0,.08); overflow:hidden; display:flex; flex-direction:column; }
  header{ padding:18px 20px; border-bottom:1px solid #e7ebf0; display:flex; gap:12px; flex-wrap:wrap; align-items:end; }
  header h1{ font-size:18px; margin:0; font-weight:800; }
  .field{ flex:1; min-width:240px; }
  label{ display:block; font-size:13px; color:#555; margin-bottom:6px; }
  input[type="text"]{
    width:100%; padding:14px 16px; border:1px solid #d7dde5; border-radius:12px; font-size:18px;
  }
  .actions-top{ display:flex; gap:12px; flex: 0 0 auto; }
  .btn-big{
    flex:1 1 240px; padding:18px 20px; font-weight:900; font-size:20px; letter-spacing:.2px;
    border:0; border-radius:16px; cursor:pointer; box-shadow:0 10px 26px rgba(15,98,254,.18);
    transition: transform .02s ease, filter .2s ease;
  }
  .btn-big:active{ transform:scale(.98); }
  .entrada{ background:#0f62fe; color:#fff; }
  .salida{ background:#ef4444; color:#fff; box-shadow:0 10px 26px rgba(239,68,68,.22); }
  main{ padding:16px 20px 8px; }
  .panel-firma{ display:none; }
  .panel-firma.active{ display:block; }
  .card{ background:#fafbfc; border:1px solid #e7ebf0; border-radius:14px; padding:14px; }
  .hint{ margin:0 0 10px 0; font-weight:700; }
  canvas#sig{ width:100%; height:300px; border:1px dashed #cbd5e1; border-radius:12px; background:#fff; touch-action:none; }
  .row{ display:flex; gap:12px; flex-wrap:wrap; margin-top:12px; }
  .btn{
    padding:14px 16px; border:0; border-radius:12px; cursor:pointer; font-weight:800; letter-spacing:.2px;
    box-shadow:0 6px 20px rgba(17,17,17,.06);
  }
  .primary{ background:#111; color:#fff; }
  .ghost{ background:#e9eef6; }
  .danger{ background:#dc3545; color:#fff; }
  .status{
    height:var(--statusH); display:flex; align-items:center; justify-content:space-between;
    padding:0 14px; border-top:1px solid #e7ebf0; color:#444; background:#fff;
  }
  .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
  .small{ font-size:12px; color:#666; }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Fichaje</h1>
    <div class="field" style="flex:2;">
      <label>Nombre</label>
      <input id="nombre" type="text" list="empleados" placeholder="Escribe tu nombre..." autocomplete="name" />
      <datalist id="empleados">
        <option value="Emilio Fernández Muñoz"></option>
        <option value="Fernando Lloris Sánchez"></option>
        <option value="Luis Bou García"></option>
        <option value="Emilio Muñoz Usero"></option>
      </datalist>
    </div>
    <div class="actions-top">
      <button id="btnEntrada" class="btn-big entrada">Fichar ENTRADA</button>
      <button id="btnSalida"  class="btn-big salida">Fichar SALIDA</button>
    </div>
  </header>

  <main>
    <section id="panelFirma" class="panel-firma">
      <div class="card">
        <p id="hint" class="hint">Firma para confirmar…</p>
        <canvas id="sig"></canvas>
        <div class="row">
          <button id="btnClear" class="btn danger">Borrar firma</button>
          <button id="btnEnviar" class="btn primary">Enviar</button>
          <button id="btnCancelar" class="btn ghost">Cancelar</button>
        </div>
        <p class="small">Firma con el dedo o lápiz digital. Luego pulsa “Enviar”.</p>
      </div>
    </section>
  </main>

  <div class="status">
    <div id="status_text">Listo.</div>
    <div class="mono small" id="clock"></div>
  </div>
</div>

<audio id="beep_ok" preload="auto">
  <!-- beep mínimo -->
  <source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYBCAAAAB8AAA==" type="audio/wav" />
</audio>

<script>
/* ====== CONFIG ====== */
const ENDPOINT = "https://script.google.com/macros/s/AKfycbxlR17AJQw87pZgALcfRTE__1ud65aXrRj7B0OG7tu3Lj5s1bCsFRw09WS81qDa2Q-k/exec";
const JPEG_QUALITY = 0.75;

/* ====== ELEMENTOS ====== */
const $ = s => document.querySelector(s);
const statusEl = $('#status_text');
const beepOk   = $('#beep_ok');
const nombreEl = $('#nombre');
const panel    = $('#panelFirma');
const hintEl   = $('#hint');
const btnEntrada = $('#btnEntrada');
const btnSalida  = $('#btnSalida');
const btnEnviar  = $('#btnEnviar');
const btnCancelar= $('#btnCancelar');
const btnClear   = $('#btnClear');

let tipoActual = null;
let firmando = false;

/* ====== RELOJ ====== */
setInterval(()=>{
  const d=new Date(); $('#clock').textContent=
    d.toLocaleDateString('es-ES',{weekday:'short',day:'2-digit',month:'2-digit'})+' '+d.toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
}, 250);

/* ====== STATUS ====== */
function setStatus(t){ statusEl.textContent = t }

/* ====== FLUJO ====== */
btnEntrada.onclick = ()=> abrirFirma('entrada');
btnSalida.onclick  = ()=> abrirFirma('salida');

function abrirFirma(tipo){
  const nombre = cleanName();
  if(!nombre) return;
  tipoActual = tipo;
  hintEl.textContent = `Firma para confirmar la ${tipo.toUpperCase()} de “${nombre}” y pulsa Enviar.`;
  panel.classList.add('active');
  firmando = true;
  setStatus(`Firmando (${tipo})…`);
}

btnCancelar.onclick = ()=>{
  panel.classList.remove('active');
  firmando = false;
  clearSig();
  setStatus('Cancelado.');
};

btnClear.onclick = ()=>{
  clearSig();
  setStatus('Firma borrada.');
};

btnEnviar.onclick = async()=>{
  if(!firmando) return;
  const nombre = cleanName();
  if(!nombre) return;
  if(!hasStroke){ setStatus('Firma requerida.'); return; }

  disableAll(true);
  setStatus('Enviando (firma)…');

  try{
    const blob = await canvasToJpegBlob(sig, JPEG_QUALITY);
    await postFichaje({ nombre, tipo: tipoActual, modo: 'firma', blob });
    okFeedback(nombre);
    panel.classList.remove('active');
    firmando = false;
    clearSig();
  }catch(err){
    setStatus('Error envío: '+err.message);
  }finally{
    disableAll(false);
  }
};

/* ====== CANVAS FIRMA ====== */
const sig = $('#sig');
const ctxSig = sig.getContext('2d');
let drawing=false, hasStroke=false, last={x:0,y:0};

function fitSigCanvas(){
  const ratio = Math.max(window.devicePixelRatio||1,1);
  const cssW = sig.clientWidth || sig.parentElement.clientWidth;
  const cssH = sig.clientHeight || 300;
  sig.width = Math.round(cssW * ratio);
  sig.height= Math.round(cssH * ratio);
  ctxSig.setTransform(1,0,0,1,0,0);
  ctxSig.scale(ratio, ratio);
  ctxSig.lineCap = 'round';
  ctxSig.lineJoin = 'round';
  ctxSig.lineWidth = 3;
  ctxSig.strokeStyle = '#111';
}
function clearSig(){
  ctxSig.clearRect(0,0,sig.width, sig.height);
  hasStroke=false;
}
function pos(ev){
  const rect = sig.getBoundingClientRect();
  const x = (ev.touches? ev.touches[0].clientX : ev.clientX) - rect.left;
  const y = (ev.touches? ev.touches[0].clientY : ev.clientY) - rect.top;
  return {x,y};
}
function start(ev){ drawing=true; hasStroke=true; last=pos(ev); ev.preventDefault(); }
function move(ev){ if(!drawing) return; const p=pos(ev); ctxSig.beginPath(); ctxSig.moveTo(last.x,last.y); ctxSig.lineTo(p.x,p.y); ctxSig.stroke(); last=p; ev.preventDefault(); }
function end(){ drawing=false; }

sig.addEventListener('mousedown', start);
sig.addEventListener('mousemove', move);
window.addEventListener('mouseup', end);
sig.addEventListener('touchstart', start, {passive:false});
sig.addEventListener('touchmove', move, {passive:false});
sig.addEventListener('touchend', end, {passive:false});

window.addEventListener('resize', ()=>{
  // preservar trazos al redimensionar
  const img = sig.toDataURL('image/png');
  fitSigCanvas();
  const im = new Image(); im.onload=()=>ctxSig.drawImage(im,0,0, sig.clientWidth, sig.clientHeight); im.src=img;
});
fitSigCanvas();

/* ====== UTIL ====== */
function canvasToJpegBlob(cnv, quality=0.75){
  return new Promise(res=> cnv.toBlob(b=>res(b),'image/jpeg',quality));
}
function disableAll(dis){ document.querySelectorAll('button, input').forEach(b=>b.disabled=dis); }
function okFeedback(nombre){
  try{ beepOk.currentTime=0; beepOk.play().catch(()=>{}); }catch(_){}
  const hhmmss = new Date().toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  setStatus(`OK: ${nombre} — enviado ${hhmmss}.`);
}
function cleanName(){
  const v = (nombreEl.value||'').trim();
  if(!v){ setStatus('Escribe tu nombre.'); nombreEl.focus(); }
  return v;
}

/* ====== POST FICHAJE ====== */
/* Espera en GAS: nombre, tipo, modo='firma', imagen (JPEG). */
async function postFichaje({nombre, tipo, modo, blob}){
  const fd = new FormData();
  fd.append('nombre', nombre);
  fd.append('tipo', tipo);
  fd.append('modo', modo);
  if(blob) fd.append('imagen', blob, 'firma.jpg');

  const ctrl = new AbortController();
  const t = setTimeout(()=>ctrl.abort(), 9000);
  try{
    const r = await fetch(ENDPOINT, { method:'POST', body:fd, signal:ctrl.signal });
    clearTimeout(t);
    const txt = await r.text();
    if(!r.ok) throw new Error('HTTP '+r.status+' '+txt);
    // opcional: mostrar respuesta del servidor si no contiene "OK"
    if(!/OK/i.test(txt)) setStatus(txt.trim());
    return true;
  }catch(e){
    // Fallback GET mínimo para no perder el fichaje (sin imagen)
    setStatus('POST falló, usando GET sin imagen…');
    const url = `${ENDPOINT}?nombre=${encodeURIComponent(nombre)}&tipo=${encodeURIComponent(tipo)}&modo=${encodeURIComponent(modo)}`;
    const r2 = await fetch(url, { method:'GET', cache:'no-store' });
    const txt2 = await r2.text();
    if(!r2.ok) throw new Error('GET '+r2.status+': '+txt2);
    return true;
  }
}

/* ====== No-cache suave (opcional) ====== */
if('serviceWorker' in navigator){
  navigator.serviceWorker.register(URL.createObjectURL(new Blob([`
    self.addEventListener('install', e=>self.skipWaiting());
    self.addEventListener('activate', e=>self.clients.claim());
    self.addEventListener('fetch', e=>{
      e.respondWith(fetch(e.request, {cache:'no-store'}).catch(()=>fetch(e.request)));
    });
  `], {type:'text/javascript'})));
}
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Fichaje — Firma</title>
<style>
  :root { --gap:10px; --r:12px; --maxw:720px; }
  *{ box-sizing:border-box; }
  html,body{ height:100%; margin:0; font-family:system-ui, Arial, sans-serif; color:#111; }
  body{ background:#f5f7fa; display:grid; place-items:start center; padding:var(--gap); }
  .wrap{ width:100%; max-width:var(--maxw); background:#fff; border-radius:var(--r); box-shadow:0 4px 18px rgba(0,0,0,.08); padding:12px; }
  h1{ margin:0 0 6px 0; font-size:18px; font-weight:800; }
  .grid{ display:grid; grid-template-columns:1fr 1fr; gap:8px; }
  @media (max-width:520px){ .grid{ grid-template-columns:1fr; } }
  .btn{
    width:100%; padding:12px; border:0; border-radius:10px; cursor:pointer; font-weight:800; font-size:16px;
    box-shadow:0 4px 12px rgba(0,0,0,.06); color:#fff; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }
  .entrada{ background:#1e9a3c; }
  .salida{  background:#d33843; }
  .card{ margin-top:10px; border:1px solid #e7ebf0; border-radius:10px; padding:10px; background:#fafbfc; }
  .row{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
  .btn-sm{ padding:10px 12px; border:0; border-radius:8px; font-weight:800; background:#111; color:#fff; }
  .btn-ghost{ background:#e9eef6; color:#111; }
  #sig{ width:100%; height:200px; background:#fff; border:1px dashed #cbd5e1; border-radius:8px; touch-action:none; }
  .status{ margin-top:8px; font-size:12px; color:#444; display:flex; justify-content:space-between; }
  .mono{ font-family:ui-monospace, Menlo, Consolas, monospace; }
</style>
</head>
<body>
<div class="wrap">
  <h1>Fichaje</h1>

  <!-- BOTONES PEQUEÑOS: ENTRADA (verde) / SALIDA (rojo) -->
  <div id="btns" class="grid"></div>

  <!-- FIRMA SIEMPRE VISIBLE Y COMPACTA -->
  <div class="card">
    <div id="hint" style="font-weight:700; font-size:14px;">Pulsa un botón, firma y Enviar.</div>
    <canvas id="sig"></canvas>
    <div class="row">
      <button id="btnClear"  class="btn-sm btn-ghost">Borrar firma</button>
      <button id="btnEnviar" class="btn-sm">Enviar</button>
    </div>
  </div>

  <div class="status">
    <div id="status">Listo.</div>
    <div id="clock" class="mono"></div>
  </div>
</div>

<audio id="beep_ok" preload="auto">
  <source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYBCAAAAB8AAA==" type="audio/wav" />
</audio>

<script>
/* ===== CONFIG ===== */
const ENDPOINT = "https://script.google.com/macros/s/AKfycbxlR17AJQw87pZgALcfRTE__1ud65aXrRj7B0OG7tu3Lj5s1bCsFRw09WS81qDa2Q-k/exec";
const JPEG_QUALITY = 0.8;

/* Nombres de la plantilla (ajusta aquí si hace falta) */
const WORKERS = [
  "Marcos Bernal Ortega",
  "Emilio Fernández Muñoz",
  "Fernando Lloris Sánchez",
  "Luis Bou García",
  "Emilio Muñoz Usero"
];

/* ===== UI ===== */
const $ = s => document.querySelector(s);
const statusEl = $('#status');
const clockEl  = $('#clock');
const hintEl   = $('#hint');
const beepOk   = $('#beep_ok');
const grid     = $('#btns');

let nombreActual = null;
let tipoActual   = null;

/* Reloj */
setInterval(()=>{
  const d = new Date();
  clockEl.textContent = d.toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
}, 250);

/* Render botones pequeños */
function renderButtons(){
  grid.innerHTML = '';
  for(const n of WORKERS){
    const bIn = document.createElement('button');
    bIn.className = 'btn entrada';
    bIn.textContent = `${n} — ENTRADA`;
    bIn.onclick = ()=> elegir(n,'entrada');
    grid.appendChild(bIn);

    const bOut = document.createElement('button');
    bOut.className = 'btn salida';
    bOut.textContent = `${n} — SALIDA`;
    bOut.onclick = ()=> elegir(n,'salida');
    grid.appendChild(bOut);
  }
}
renderButtons();

function elegir(nombre,tipo){
  nombreActual = nombre;
  tipoActual   = tipo;
  hintEl.textContent = `Firma: ${nombre} — ${tipo.toUpperCase()}. Luego pulsa Enviar.`;
  status('Firmando…');
  clearSig();
}

/* ===== Canvas firma (compacto) ===== */
const sig = $('#sig');
const ctx = sig.getContext('2d');
let drawing=false, hasStroke=false, last={x:0,y:0};

function fit(){
  const r = Math.max(window.devicePixelRatio||1,1);
  const cssW = sig.clientWidth || 300;
  const cssH = sig.clientHeight|| 200;
  sig.width = Math.round(cssW*r);
  sig.height= Math.round(cssH*r);
  ctx.setTransform(1,0,0,1,0,0);
  ctx.scale(r,r);
  ctx.lineCap='round'; ctx.lineJoin='round'; ctx.lineWidth=2.5; ctx.strokeStyle='#111';
}
function clearSig(){ ctx.clearRect(0,0,sig.width,sig.height); hasStroke=false; }
function pos(ev){
  const rect = sig.getBoundingClientRect();
  const x = (ev.touches? ev.touches[0].clientX : ev.clientX) - rect.left;
  const y = (ev.touches? ev.touches[0].clientY : ev.clientY) - rect.top;
  return {x,y};
}
function start(ev){ drawing=true; hasStroke=true; last=pos(ev); ev.preventDefault(); }
function move(ev){ if(!drawing) return; const p=pos(ev); ctx.beginPath(); ctx.moveTo(last.x,last.y); ctx.lineTo(p.x,p.y); ctx.stroke(); last=p; ev.preventDefault(); }
function end(){ drawing=false; }
fit();
window.addEventListener('resize', ()=>{
  const img = sig.toDataURL('image/png');
  fit();
  const im = new Image(); im.onload=()=>ctx.drawImage(im,0,0,sig.clientWidth,sig.clientHeight); im.src=img;
});
sig.addEventListener('mousedown', start); sig.addEventListener('mousemove', move); window.addEventListener('mouseup', end);
sig.addEventListener('touchstart', start, {passive:false}); sig.addEventListener('touchmove', move, {passive:false}); sig.addEventListener('touchend', end, {passive:false});

/* ===== Enviar ===== */
$('#btnClear').onclick = ()=>{ clearSig(); status('Firma borrada.'); };

$('#btnEnviar').onclick = async()=>{
  if(!nombreActual || !tipoActual){ status('Pulsa un botón primero.'); return; }
  if(!hasStroke){ status('Firma requerida.'); return; }

  disable(true);
  status('Enviando…');
  try{
    const blob = await new Promise(res=> sig.toBlob(b=>res(b),'image/jpeg',JPEG_QUALITY));
    await postFichaje({nombre:nombreActual, tipo:tipoActual, blob});
    ok(nombreActual);
    clearSig();
  }catch(e){
    status('Error: '+e.message);
  }finally{
    disable(false);
  }
};

function disable(dis){ document.querySelectorAll('button').forEach(b=>b.disabled=dis); }
function status(t){ statusEl.textContent=t; }
function ok(nombre){
  try{ beepOk.currentTime=0; beepOk.play().catch(()=>{}); }catch(_){}
  const h = new Date().toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  status(`OK: ${nombre} — enviado ${h}.`);
}

/* POST (firma) + fallback GET sin imagen */
async function postFichaje({nombre,tipo,blob}){
  const fd = new FormData();
  fd.append('nombre', nombre);
  fd.append('tipo', tipo);
  fd.append('modo', 'firma');
  fd.append('imagen', blob, 'firma.jpg');

  const ctrl = new AbortController();
  const t = setTimeout(()=>ctrl.abort(), 9000);
  try{
    const r = await fetch(ENDPOINT,{method:'POST',body:fd,signal:ctrl.signal});
    clearTimeout(t);
    const txt = await r.text();
    if(!r.ok) throw new Error('HTTP '+r.status+' '+txt);
    if(!/OK/i.test(txt)) status(txt.trim());
    return true;
  }catch(e){
    status('POST falló, usando GET sin imagen…');
    const url = `${ENDPOINT}?nombre=${encodeURIComponent(nombre)}&tipo=${encodeURIComponent(tipo)}&modo=firma`;
    const r2 = await fetch(url,{method:'GET',cache:'no-store'});
    const txt2 = await r2.text();
    if(!r2.ok) throw new Error('GET '+r2.status+': '+txt2);
    return true;
  }
}
</script>
</body>
</html>

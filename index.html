<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Fichaje</title>
<style>
  :root{--w:820px}
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;font-family:system-ui,Arial,sans-serif;color:#111}
  body{background:#f3f5f7;display:flex;justify-content:center}
  .wrap{width:100%;max-width:var(--w);padding:18px}
  h1{margin:6px 0 2px;font-size:22px;text-align:center}
  .sub{margin:0 0 14px;text-align:center;color:#666;font-size:13px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;max-width:820px;margin:0 auto}
  @media (max-width:620px){.grid{grid-template-columns:1fr}}
  .btn{
    padding:12px 14px;height:46px;border:0;border-radius:12px;cursor:pointer;
    font-weight:800;font-size:15px;box-shadow:0 3px 10px rgba(0,0,0,.06);color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis
  }
  .in{background:#22a559} .out{background:#d04444}
  .card{margin:12px auto 0;border:1px solid #e3e7ee;border-radius:12px;background:#fff;max-width:820px}
  .card .pad{padding:10px}
  #sig{width:100%;height:160px;background:#fff;border:1.5px dashed #cbd5e1;border-radius:10px;touch-action:none}
  .actions{display:flex;gap:8px;justify-content:center;padding:10px}
  .actions .b{padding:10px 14px;border:0;border-radius:10px;font-weight:800;cursor:pointer}
  .clear{background:#eef1f5;color:#111}
  .send{background:#1366ff;color:#fff}
  .status{margin-top:6px;text-align:center;font-size:12px;color:#444}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
</style>
</head>
<body>
<div class="wrap">
  <h1>Fichaje</h1>
  <div class="sub">Pulsa tu botón, firma y envía.</div>

  <div id="grid" class="grid"></div>

  <div class="card">
    <div class="pad"><canvas id="sig"></canvas></div>
    <div class="actions">
      <button class="b clear" id="btnClear">Borrar</button>
      <button class="b send"  id="btnEnviar">Enviar</button>
    </div>
  </div>

  <div class="status"><span id="status">Listo.</span> · <span id="clock" class="mono"></span></div>
</div>

<audio id="beep_ok" preload="auto">
  <source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYBCAAAAB8AAA==" type="audio/wav"/>
</audio>

<script>
/* ===== CONFIG ===== */
const ENDPOINT="https://script.google.com/macros/s/AKfycbxlR17AJQw87pZgALcfRTE__1ud65aXrRj7B0OG7tu3Lj5s1bCsFRw09WS81qDa2Q-k/exec";
const WORKERS=["Marcos Bernal Ortega","Carla Gomez Torres","Laura Sánchez Vidal","Javier Torres Molina"];

/* ===== UI ===== */
const $=s=>document.querySelector(s);
const grid=$("#grid"),statusEl=$("#status"),clock=$("#clock");
let nombre=null,tipo=null,sending=false;

/* reloj */
setInterval(()=>{const d=new Date();clock.textContent=d.toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit",second:"2-digit"})},250);

/* botones trabajadores */
function render(){
  grid.innerHTML="";
  for(const n of WORKERS){
    const bIn=document.createElement("button");
    bIn.className="btn in"; bIn.textContent=`${n} — ENTRADA`; bIn.onclick=()=>pick(n,"entrada"); grid.appendChild(bIn);
    const bOut=document.createElement("button");
    bOut.className="btn out"; bOut.textContent=`${n} — SALIDA`; bOut.onclick=()=>pick(n,"salida"); grid.appendChild(bOut);
  }
}
render();

function pick(n,t){ if(sending) return; nombre=n; tipo=t; setStatus(`Seleccionado: ${n} — ${t.toUpperCase()}. Firma y pulsa Enviar.`); clearSig(); }

/* ===== firma (PNG, fondo blanco, trazo grueso) ===== */
const sig=$("#sig"),ctx=sig.getContext("2d",{willReadFrequently:true});
let drawing=false,hasStroke=false,last={x:0,y:0};

function paintWhite(){
  ctx.save();
  ctx.setTransform(1,0,0,1,0,0);
  ctx.fillStyle="#fff";
  ctx.fillRect(0,0,sig.width,sig.height);
  ctx.restore();
}

function fit(){
  const r=Math.max(devicePixelRatio||1,1);
  const w=sig.clientWidth||600,h=sig.clientHeight||160;
  // Guardar contenido si existe
  const backup=ctx.getImageData(0,0,sig.width||1,sig.height||1);
  sig.width=Math.round(w*r); sig.height=Math.round(h*r);
  ctx.setTransform(r,0,0,r,0,0);
  paintWhite();
  // Restaurar si había algo (evitar fondo negro)
  if(backup.width>0&&backup.height>0){ ctx.putImageData(backup,0,0); }
  ctx.lineCap="round"; ctx.lineJoin="round"; ctx.lineWidth=3.2; ctx.strokeStyle="#000";
}
fit();
addEventListener("resize",()=>{ const tmp=new Image(); tmp.src=sig.toDataURL("image/png"); tmp.onload=()=>{ fit(); ctx.drawImage(tmp,0,0,sig.clientWidth,sig.clientHeight); }; });

function pos(e){const r=sig.getBoundingClientRect(); const x=(e.touches?e.touches[0].clientX:e.clientX)-r.left; const y=(e.touches?e.touches[0].clientY:e.clientY)-r.top; return {x,y};}
function start(e){drawing=true; last=pos(e); e.preventDefault();}
function move(e){if(!drawing) return; const p=pos(e); ctx.beginPath(); ctx.moveTo(last.x,last.y); ctx.lineTo(p.x,p.y); ctx.stroke(); last=p; hasStroke=true; e.preventDefault();}
function end(){drawing=false;}
sig.addEventListener("mousedown",start); sig.addEventListener("mousemove",move); addEventListener("mouseup",end);
sig.addEventListener("touchstart",start,{passive:false}); sig.addEventListener("touchmove",move,{passive:false}); sig.addEventListener("touchend",end);

function clearSig(){ paintWhite(); hasStroke=false; }
$("#btnClear").onclick=()=>{ clearSig(); setStatus("Firma borrada."); };

/* ===== envío (dataURL PNG) ===== */
$("#btnEnviar").onclick=send;

function setStatus(t){ statusEl.textContent=t; }
function disable(d){ document.querySelectorAll("button").forEach(b=>b.disabled=d); }
function beep(){ try{ const a=$("#beep_ok"); a.currentTime=0; a.play().catch(()=>{});}catch(_){ } }

async function send(){
  if(sending) return;
  if(!nombre||!tipo){ setStatus("Selecciona trabajador y tipo."); return; }
  if(!hasStroke){ setStatus("Firma requerida."); return; }

  sending=true; disable(true); setStatus("Enviando…");
  try{
    const dataURL = sig.toDataURL("image/png");        // PNG con fondo blanco
    const txId = "tx_"+Date.now()+"_"+Math.random().toString(36).slice(2,8);

    const fd=new FormData();
    fd.append("nombre", nombre);
    fd.append("tipo",   tipo);
    fd.append("modo",   "firma");
    fd.append("txId",   txId);
    fd.append("imagen", dataURL);

    await fetch(ENDPOINT,{method:"POST",body:fd});

    beep();
    const h=new Date().toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit",second:"2-digit"});
    setStatus(`OK: ${nombre} — ${tipo} ${h}`);
    clearSig();
  }catch(e){
    setStatus("Error de red");
  }finally{
    sending=false; disable(false);
  }
}
</script>
</body>
</html>
